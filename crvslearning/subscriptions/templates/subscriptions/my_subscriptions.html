{% extends 'subscriptions/base_subscriptions.html' %}
{% load static %}

{% block head_title %}Mes abonnements{% endblock %}

{% block subscription_content %}
<div class="card">
    <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Mes abonnements</h4>
        </div>
    </div>
    
    <div class="card-body">
        {% if subscriptions %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for subscription in subscriptions %}
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <img src="{{ subscription.trainer.avatar.url|default:'/static/images/default-avatar.png' }}" 
                                 class="rounded-circle mb-3" 
                                 alt="{{ subscription.trainer.get_full_name }}"
                                 width="100" height="100">
                            <h5 class="card-title">
                                <a href="{% url 'users:instructor_public' subscription.trainer.username %}" 
                                   class="text-decoration-none">
                                    {{ subscription.trainer.get_full_name|default:subscription.trainer.username }}
                                </a>
                            </h5>
                            <p class="text-muted mb-2">
                                <i class="fas fa-chalkboard-teacher me-1"></i>
                                Formateur
                            </p>
                            <div class="d-flex justify-content-center gap-2">
                                <a href="{% url 'users:instructor_public' subscription.trainer.username %}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye me-1"></i> Voir le profil
                                </a>
                                <button class="btn btn-sm btn-outline-danger toggle-subscription" 
                                        data-username="{{ subscription.trainer.username }}">
                                    <i class="fas fa-user-minus me-1"></i> Se désabonner
                                </button>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-top-0 text-muted text-center">
                            <small>Abonné depuis le {{ subscription.created_at|date:"d/m/Y" }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <div class="mb-3">
                    <i class="fas fa-user-friends fa-4x text-muted"></i>
                </div>
                <h5>Vous n'êtes abonné à aucun formateur</h5>
                <p class="text-muted">Découvrez nos formateurs et abonnez-vous pour suivre leur contenu.</p>
                <a href="{% url 'courses:all_courses' %}" class="btn btn-primary mt-2">
                    <i class="fas fa-book-open me-1"></i> Découvrir les cours
                </a>
            </div>
        {% endif %}
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion du désabonnement
    document.querySelectorAll('.toggle-subscription').forEach(button => {
        button.addEventListener('click', function() {
            const username = this.dataset.username;
            const card = this.closest('.col');
            
            fetch(`/subscriptions/toggle/${username}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'unsubscribed') {
                    // Supprimer la carte de l'abonnement
                    card.remove();
                    
                    // Mettre à jour le compteur si présent
                    const countElement = document.querySelector('.subscription-count');
                    if (countElement) {
                        const count = parseInt(countElement.textContent) - 1;
                        countElement.textContent = count > 0 ? count : 0;
                    }
                    
                    // Afficher un message de confirmation
                    if (typeof showToast === 'function') {
                        showToast('Vous vous êtes désabonné avec succès');
                    }
                }
            })
            .catch(error => {
                console.error('Erreur lors du désabonnement:', error);
                if (typeof showToast === 'function') {
                    showToast('Une erreur est survenue', 'error');
                }
            });
        });
    });
});
</script>
{% endblock %}

{% endblock %}
