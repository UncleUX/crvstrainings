{% extends "base.html" %}
{% load static humanize %}

{% block title %}Recherche: {{ q }}{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Barre de recherche -->
  <div class="mb-4">
    <form method="get" action="{% url 'courses:search' %}" class="d-flex">
      <div class="input-group">
        <input type="text" name="q" value="{{ q }}" class="form-control form-control-lg" placeholder="Rechercher des vidéos, des chaînes...">
        <button type="submit" class="btn btn-primary px-4">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </form>
  </div>
  
  <!-- Filtres de recherche -->
  <div class="mb-4 border-bottom pb-3">
    <div class="d-flex flex-wrap gap-2">
      <a href="?q={{ q }}&type=all" class="btn btn-sm rounded-pill {% if search_type == 'all' %}btn-dark{% else %}btn-outline-secondary{% endif %}">
        <i class="fas fa-th-large me-1"></i> Tous
      </a>
      <a href="?q={{ q }}&type=channels" class="btn btn-sm rounded-pill {% if search_type == 'channels' %}btn-dark{% else %}btn-outline-secondary{% endif %}">
        <i class="fas fa-user-tie me-1"></i> Chaînes
      </a>
      <a href="?q={{ q }}&type=videos" class="btn btn-sm rounded-pill {% if search_type == 'videos' %}btn-dark{% else %}btn-outline-secondary{% endif %}">
        <i class="fas fa-play-circle me-1"></i> Vidéos
      </a>
    </div>
  </div>

  <!-- Résultats des chaînes -->
  {% if search_type in 'all channels' and instructor_results %}
    <section class="mb-5">
      <h4 class="mb-4">Chaînes</h4>
      <div class="row g-4">
        {% for instructor in instructor_results %}
          <div class="col-12">
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <div class="d-flex align-items-start">
                  <a href="{% url 'users:instructor_public' instructor.username %}?from_search=true" class="text-decoration-none">
                    <img src="{{ instructor.avatar.url|default:'/static/images/default-avatar.png' }}" 
                         class="rounded-circle me-3" width="80" height="80" 
                         alt="{{ instructor.get_full_name|default:instructor.username }}">
                  </a>
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center">
                      <div>
                        <h5 class="mb-1">
<a href="{% url 'users:instructor_public' instructor.username %}?from_search=true" class="text-decoration-none text-dark">
                            {{ instructor.get_full_name|default:instructor.username }}
                          </a>
                        </h5>
                        <div class="text-muted mb-2">
                          <span class="me-3"><i class="fas fa-users me-1"></i> {{ instructor.subscribers_count|default:0|intcomma }} abonnés</span>
                          <span><i class="fas fa-play-circle me-1"></i> {{ instructor.courses_count|default:0|intcomma }} cours</span>
                        </div>
                        {% if instructor.bio %}
                          <p class="text-muted mb-2">{{ instructor.bio|truncatechars:200 }}</p>
                        {% endif %}
                      </div>
                      <div class="ms-auto">
                        <a href="{% url 'users:instructor_public' instructor.username %}?from_search=true" 
                           class="btn btn-outline-dark rounded-pill">
                          <i class="fas fa-tv me-1"></i> Voir la chaîne
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </section>
  {% endif %}

  <!-- Résultats des cours -->
  {% if search_type in 'all courses' and course_results %}
    <section class="mb-5">
      <h4 class="mb-4">Cours</h4>
      <div class="row g-4">
        {% for course in course_results %}
          <div class="col-md-6 col-lg-4 col-xl-3">
            <div class="card h-100 border-0 shadow-sm">
              <a href="{% url 'courses:course_detail' course.id %}" class="text-decoration-none">
                <div style="height: 180px; overflow: hidden; background-color: #f8f9fa;">
                  {% if course.thumbnail %}
                    <img src="{{ course.thumbnail.url }}" class="card-img-top w-100 h-100" alt="{{ course.title }}" style="object-fit: cover;">
                  {% else %}
                    <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-light">
                      <i class="fas fa-book text-muted" style="font-size: 3rem;"></i>
                    </div>
                  {% endif %}
                </div>
                <div class="card-body">
                  <h6 class="card-title text-dark mb-1">{{ course.title|truncatechars:50 }}</h6>
                  <p class="small text-muted mb-2">
                    Par {{ course.created_by.get_full_name|default:course.created_by.username }}
                  </p>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-primary bg-opacity-10 text-primary">{{ course.category.name|default:'Général' }}</span>
                    <div class="text-muted small">
                      <i class="far fa-play-circle me-1"></i> {{ course.lessons_count|default:0 }} leçons
                    </div>
                  </div>
                  {% if course.price > 0 %}
                    <div class="mt-2">
                      <span class="fw-bold text-dark">{{ course.price|floatformat:2 }} €</span>
                      {% if course.original_price > course.price %}
                        <span class="text-muted text-decoration-line-through ms-2">{{ course.original_price|floatformat:2 }} €</span>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="mt-2">
                      <span class="badge bg-success bg-opacity-10 text-success">Gratuit</span>
                    </div>
                  {% endif %}
                </div>
              </a>
            </div>
          </div>
        {% endfor %}
      </div>
    </section>
  {% endif %}

  <!-- Résultats des vidéos -->
  {% if search_type in 'all videos' and video_results %}
    <section class="mb-5">
      <h4 class="mb-4">Vidéos</h4>
      <div class="row g-4">
        {% for video in video_results %}
          <div class="col-12 col-md-6 col-lg-4 col-xl-3">
            <div class="card h-100 border-0">
              <a href="{% url 'courses:lesson_detail' video.lesson.id %}" class="text-decoration-none">
                <div class="position-relative" style="padding-top: 56.25%; background-color: #000; border-radius: 8px; overflow: hidden;">
                  <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center">
                    <i class="fas fa-play-circle text-white" style="font-size: 3rem; opacity: 0.8;"></i>
                  </div>
                  {% if video.thumbnail %}
                    <img src="{{ video.thumbnail.url }}" class="position-absolute top-0 start-0 w-100 h-100" style="object-fit: cover;" alt="{{ video.title|default:video.lesson.title }}">
                  {% endif %}
                  <div class="position-absolute bottom-0 end-0 m-2">
                    <span class="badge bg-dark bg-opacity-75">{{ video.duration|default:'00:00' }}</span>
                  </div>
                </div>
                <div class="card-body p-3">
                  <h6 class="card-title text-dark mb-1">{{ video.title|default:video.lesson.title|truncatechars:50 }}</h6>
                  <div class="d-flex align-items-center mt-2">
                    <img src="{{ video.lesson.module.course.created_by.avatar.url|default:'/static/images/default-avatar.png' }}" 
                         class="rounded-circle me-2" width="24" height="24" 
                         alt="{{ video.lesson.module.course.created_by.get_full_name|default:video.lesson.module.course.created_by.username }}">
                    <span class="small text-muted">{{ video.lesson.module.course.created_by.get_full_name|default:video.lesson.module.course.created_by.username }}</span>
                  </div>
                  <div class="d-flex text-muted small mt-2">
                    <span class="me-2"><i class="fas fa-eye me-1"></i> {{ video.video_views_count|default:0|intcomma }} vue{{ video.video_views_count|default:0|pluralize }}</span>
                    <span class="mx-2">•</span>
                    <span>{{ video.lesson.created_at|timesince }}</span>
                  </div>
                </div>
              </a>
            </div>
          </div>
        {% endfor %}
      </div>
    </section>
  {% endif %}

  <!-- Message si aucun résultat -->
  {% if not has_results %}
    <div class="text-center py-5">
      <div class="mb-4">
        <i class="fas fa-search fa-4x text-muted"></i>
      </div>
      <h4 class="mb-3">Aucun résultat trouvé pour "{{ q }}"</h4>
      <p class="text-muted">Essayez avec d'autres termes de recherche ou explorez nos contenus.</p>
      <div class="mt-3">
        <a href="{% url 'courses:all_courses' %}" class="btn btn-outline-primary me-2">
          <i class="fas fa-book me-1"></i> Voir tous les cours
        </a>
        <a href="{% url 'users:instructors' %}" class="btn btn-outline-secondary">
          <i class="fas fa-user-tie me-1"></i> Découvrir les formateurs
        </a>
        <h5 class="mb-3">Suggestions de recherche :</h5>
        <div class="d-flex flex-wrap justify-content-center gap-2">
          <a href="?q=débutant" class="btn btn-sm btn-outline-secondary rounded-pill">Débutant</a>
          <a href="?q=programmation" class="btn btn-sm btn-outline-secondary rounded-pill">Programmation</a>
          <a href="?q=marketing" class="btn btn-sm btn-outline-secondary rounded-pill">Marketing</a>
          <a href="?q=design" class="btn btn-sm btn-outline-secondary rounded-pill">Design</a>
          <a href="?q=langues" class="btn btn-sm btn-outline-secondary rounded-pill">Langues</a>
        </div>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
