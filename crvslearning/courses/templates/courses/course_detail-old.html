{% extends "base.html" %}

{% block content %}
<div class="container px-0">
<section class="course-hero">
  <div class="hero-media{% if not course.thumbnail %} no-thumb{% endif %}"{% if course.thumbnail %} style="background-image: url('{{ course.thumbnail.url }}');"{% endif %}></div>
  <div class="hero-overlay"></div>
  <div class="hero-inner">
    <h1 class="title">{{ course.title }}</h1>
    <p class="desc">{{ course.description|truncatechars:180 }}</p>
    <div class="meta">
      <span class="badge">{{ nombre_inscrits }} inscrits</span>
      {% if course.category %}<span class="badge alt">{{ course.category.name }}</span>{% endif %}
      <span class="badge alt">{{ modules|length }} modules</span>
    </div>
    <div class="cta">
      {% if is_enrolled %}
        <button class="btn solid" disabled>‚úÖ Vous √™tes inscrit(e)</button>
      {% else %}
        <form method="post" action="{% url 'courses:enroll_course' course.id %}">
          {% csrf_token %}
          <button class="btn solid">S'inscrire au cours</button>
        </form>
      {% endif %}
      <!-- <button type="button" class="btn btn-outline-light ms-2" data-bs-toggle="modal" data-bs-target="#testModal">Ouvrir le modal test</button> -->
    </div>
  </div>
</section>

<div class="container" style="margin:10px 0 14px 0;">
  <!-- <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#testModal">
    Ouvrir le modal test (bouton secondaire)
  </button> -->
  <span class="text-muted" style="margin-left:8px;">Bouton ajout√© sous le hero pour test</span>
  </div>

<!-- Cert Preview Modal -->
<div class="modal fade" id="certModal" tabindex="-1" aria-labelledby="certModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content" style="height:80vh;">
      <div class="modal-header">
        <h5 class="modal-title" id="certModalLabel">Aper√ßu du certificat</h5>
        <a id="certDownloadBtn" href="#" download class="btn btn-sm btn-outline-primary" style="margin-left:auto;margin-right:8px;">T√©l√©charger</a>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0" style="height:calc(100% - 56px);">
        <object id="certFrame" data="" type="application/pdf" style="width:100%;height:100%">
          <div style="padding:16px">
            <p>Impossible d'afficher l'aper√ßu du PDF dans votre navigateur.</p>
            <p>
              <a id="certOpenNewTab" href="#" target="_blank" rel="noopener" class="btn btn-sm btn-primary">Ouvrir dans un nouvel onglet</a>
              <a id="certDownloadAlt" href="#" download class="btn btn-sm btn-outline-secondary">T√©l√©charger</a>
            </p>
          </div>
        </object>
      </div>
    </div>
  </div>
  
</div>

<script>
  document.addEventListener('DOMContentLoaded', function(){
    const certModal = document.getElementById('certModal');
    if (!certModal) return;
    certModal.addEventListener('show.bs.modal', function (event) {
      const btn = event.relatedTarget;
      let url = btn ? btn.getAttribute('data-cert-url') : '';
      if (url) {
        const sep = url.includes('?') ? '&' : '?';
        url = url + sep + 't=' + Date.now();
      }
      const frame = document.getElementById('certFrame');
      if (frame) frame.setAttribute('data', url || '');
      const dl = document.getElementById('certDownloadBtn');
      if (dl) {
        if (url) {
          dl.href = url;
          dl.style.display = '';
        } else {
          dl.href = '#';
          dl.style.display = 'none';
        }
      }
      const altOpen = document.getElementById('certOpenNewTab');
      if (altOpen) altOpen.href = url || '#';
      const altDl = document.getElementById('certDownloadAlt');
      if (altDl) altDl.href = url || '#';
    });
    certModal.addEventListener('hidden.bs.modal', function(){
      const frame = document.getElementById('certFrame');
      if (frame) frame.setAttribute('data', '');
      const dl = document.getElementById('certDownloadBtn');
      if (dl) { dl.href = '#'; dl.style.display = ''; }
      const altOpen = document.getElementById('certOpenNewTab');
      if (altOpen) altOpen.href = '#';
      const altDl = document.getElementById('certDownloadAlt');
      if (altDl) altDl.href = '#';
    });
  });
</script>

<div class="container mt-4">
    <div class="row d-flex justify-content-between">
        
  <div class="col-md-4 bg-light p-3">
  {% if is_enrolled %}
    <div class="progress-wrap">
      <div class="progress-header">
        <h3>Votre progression</h3>
        <span class="small">{{ completed_count }}/{{ total_lessons }} le√ßon{{ total_lessons|pluralize }}</span>
      </div>
      <div class="bar"><div class="fill" style="width: {{ progress_percent }}%"></div></div>
      <div class="progress mt-2" style="height: 10px;">
        <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress_percent }}%;" aria-valuenow="{{ progress_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <div class="percent">{{ progress_percent }}%</div>
      {% if is_enrolled and total_lessons %}
      <div class="mt-2">
        <form method="post" action="{% url 'courses:mark_course_completed' course.id %}" style="display:inline-block;margin-right:8px;">
          {% csrf_token %}
          <button class="btn ghost" type="submit">Marquer ce cours termin√©</button>
        </form>
      </div>
      {% endif %}
    </div>
{% endif %}
{% if levels_progress %}
<section class="levels">
  <h3>Par niveau</h3>
  <div class="level-grid">
    {% for lvl in levels_progress %}
    <div class="level-card">
      <div class="level-head"><span class="chip">{{ lvl.label }}</span><span class="mini">{{ lvl.done }}/{{ lvl.total }}</span></div>
      <div class="level-bar"><div class="fill" style="width: {{ lvl.percent }}%"></div></div>
      <div class="level-actions">
        {% if lvl.cert %}
          <button type="button" class="btn tiny solid" data-bs-toggle="modal" data-bs-target="#certModal" data-cert-url="{{ lvl.cert.pdf.url }}">Visualiser</button>
        {% elif lvl.completed and lvl.evaluation %}
          <a href="{% url 'evaluations:start_level_evaluation' course.id lvl.key %}" class="btn tiny solid">√âvaluation ({{ lvl.label }})</a>
        {% elif not lvl.completed %}
          <button class="btn tiny ghost" disabled>Compl√©tez les le√ßons</button>
        {% else %}
          <button class="btn tiny ghost" disabled>√âvaluation indisponible</button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}
{% endif %}
</div>

        <div class="col-md-8 text-white p-3">
<section class="ld-tabs">
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation"><a class="nav-link active" data-bs-toggle="tab" href="#tab-curr">Curriculum</a></li>
    <li class="nav-item" role="presentation"><a class="nav-link" data-bs-toggle="tab" href="#tab-desc">Description</a></li>
    <li class="nav-item" role="presentation"><a class="nav-link" data-bs-toggle="tab" href="#tab-res">Ressources</a></li>
  </ul>
  <div class="tab-content">
    <div id="tab-curr" class="tab-pane fade show active">
      <div class="accordion" id="modulesAcc">
        {% for module in modules %}
        <div class="accordion-item">
          <h2 class="accordion-header" id="mod-h-{{ module.id }}">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#mod-c-{{ module.id }}" aria-expanded="true" aria-controls="mod-c-{{ module.id }}">
              {{ module.title }} <span class="acc-count ms-2">({{ module.lessons.count }} le√ßon{{ module.lessons.count|pluralize }})</span>
            </button>
          </h2>
          <div id="mod-c-{{ module.id }}" class="accordion-collapse collapse show" aria-labelledby="mod-h-{{ module.id }}" data-bs-parent="#modulesAcc">
            <div class="accordion-body">
              {% if is_enrolled and module.lessons.count %}
              <form method="post" action="{% url 'courses:mark_module_completed' course.id module.id %}" class="mb-2">
                {% csrf_token %}
                <button class="btn ghost btn-sm" type="submit">Marquer ce module termin√©</button>
              </form>
              {% endif %}
              <div class="accordion" id="lessonsAcc-{{ module.id }}">
                {% for lesson in module.lessons.all %}
                <div class="accordion-item">
                  <h2 class="accordion-header" id="les-h-{{ lesson.id }}">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#les-c-{{ lesson.id }}" aria-expanded="true" aria-controls="les-c-{{ lesson.id }}">
                      {% if is_enrolled or forloop.first and forloop.parentloop.first %}
                        <a href="{% url 'courses:lesson_detail' lesson.id %}" class="stretched-link text-decoration-none">{% if is_enrolled %}üì∫{% else %}üì∫{% endif %} {{ lesson.title }}
                          {% if completed_lesson_ids and lesson.id in completed_lesson_ids %}<span class="pill" style="margin-left:8px;">Lu</span>{% endif %}
                        </a>
                      {% else %}
                        <span class="locked">üîí {{ lesson.title }}</span>
                      {% endif %}
                    </button>
                  </h2>
                  <div id="les-c-{{ lesson.id }}" class="accordion-collapse collapse show" aria-labelledby="les-h-{{ lesson.id }}" data-bs-parent="#lessonsAcc-{{ module.id }}">
                    <div class="accordion-body">
                      {% if lesson.videos.all %}
                        <ul class="video-list">
                          {% for v in lesson.videos.all %}
                            {% if v.video_file %}
                            <li class="video-item d-flex justify-content-between">
                              {% if is_enrolled or forloop.parentloop.parentloop.first and forloop.parentloop.parentloop.parentloop.first %}
                                <a href="{% url 'courses:lesson_detail' lesson.id %}" class="v-title text-decoration-none">üì∫ {{ v.title|default:lesson.title }}</a>
                              {% else %}
                                <span class="locked">üîí {{ v.title|default:lesson.title }}</span>
                              {% endif %}
                              {% if v.duration %}<span class="v-dur">{{ v.duration }}</span>{% endif %}
                            </li>
                            {% endif %}
                          {% endfor %}
                        </ul>
                      {% elif lesson.video_file %}
                        <ul class="video-list">
                          <li class="video-item d-flex justify-content-between">
                            {% if is_enrolled or forloop.first and forloop.parentloop.first %}
                              <a href="{% url 'courses:lesson_detail' lesson.id %}" class="v-title text-decoration-none">üì∫ {{ lesson.title }}</a>
                            {% else %}
                              <span class="locked">üîí {{ lesson.title }}</span>
                            {% endif %}
                            {% if lesson.duration %}<span class="v-dur">{{ lesson.duration }}</span>{% endif %}
                          </li>
                        </ul>
                      {% else %}
                        <div class="muted">Aucune vid√©o list√©e.</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% empty %}
                <div class="muted">Aucune le√ßon dans ce module.</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <p class="muted">Aucun module disponible.</p>
        {% endfor %}
      </div>
    </div>
    <div id="tab-desc" class="tab-pane fade">
      <p>{{ course.description }}</p>
    </div>
    <div id="tab-res" class="tab-pane fade">
      <div class="rating-block">
        <div class="rb-head">Note du cours: <strong>{% if avg_rating %}{{ avg_rating }}/5{% else %}N/A{% endif %}</strong> ¬∑ <span class="like-count">‚ù§ {{ like_count }}</span></div>
        {% if user.is_authenticated %}
        <div class="rb-row">
          <form method="post" action="{% url 'courses:rate_course' course.id %}" class="rating-stars">
            {% csrf_token %}
            <input type="radio" name="rating" id="star5" value="5" {% if user_rating_value == 5 %}checked{% endif %}><label for="star5">‚òÖ</label>
            <input type="radio" name="rating" id="star4" value="4" {% if user_rating_value == 4 %}checked{% endif %}><label for="star4">‚òÖ</label>
            <input type="radio" name="rating" id="star3" value="3" {% if user_rating_value == 3 %}checked{% endif %}><label for="star3">‚òÖ</label>
            <input type="radio" name="rating" id="star2" value="2" {% if user_rating_value == 2 %}checked{% endif %}><label for="star2">‚òÖ</label>
            <input type="radio" name="rating" id="star1" value="1" {% if user_rating_value == 1 %}checked{% endif %}><label for="star1">‚òÖ</label>
            <button class="btn ghost" type="submit">Noter</button>
          </form>
          <form method="post" action="{% url 'courses:toggle_like' course.id %}" class="like-form">
            {% csrf_token %}
            <button class="btn {% if user_liked %}solid{% else %}ghost{% endif %}" type="submit">{% if user_liked %}‚ù§ Je n'aime plus{% else %}‚ù§ J'aime{% endif %}</button>
          </form>
        </div>
        {% else %}
        <p class="muted">Connectez-vous pour noter et aimer ce cours.</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>
        </div>

    </div>
</div>




<style>
  .course-hero{position:relative;border-radius:16px;background:#0f172a;color:#fff;padding:18px;margin-bottom:14px;min-height:140px;overflow:hidden}
  .hero-media{position:absolute;inset:0;background-position:center;background-size:cover;filter:brightness(0.65) saturate(1.1);pointer-events:none}
  .hero-overlay{position:absolute;inset:0;background:radial-gradient(1200px 400px at 10% 120%, rgba(59,130,246,0.25), transparent),radial-gradient(1200px 400px at 90% -20%, rgba(236,72,153,0.2), transparent);mix-blend-mode:screen;pointer-events:none}
  .title{margin:0 0 6px 0}
  .desc{opacity:.9;margin:0 0 8px 0}
  .badge{display:inline-block;background:#111827;color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700;margin-right:6px}
  .hero-media.no-thumb{background-color:#0f172a}
  .hero-overlay{position:absolute;inset:0;background:radial-gradient(1200px 400px at 10% 120%, rgba(59,130,246,0.25), transparent),radial-gradient(1200px 400px at 90% -20%, rgba(236,72,153,0.2), transparent)}
  .hero-inner{position:relative;z-index:1;color:#fff;padding:38px;max-width:980px}
  .title{font-size:clamp(28px,6vw,48px);margin:0 0 8px 0;font-weight:800}
  .desc{margin:0 0 14px 0;opacity:.9}
  .meta{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  .badge{display:inline-block;background:#111827;color:#fff;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
  .badge.alt{background:rgba(255,255,255,.12)}
  .cta .btn{cursor:pointer;border:none;border-radius:10px;padding:10px 16px;font-weight:800}
  .btn.solid{background:#2563eb;color:#fff;box-shadow:0 10px 20px rgba(37,99,235,.28)}

  .progress-wrap{background:#fff;border-radius:14px;padding:16px 18px;margin:14px 0;box-shadow:0 10px 24px rgba(0,0,0,.06)}
  .progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .progress-header h3{margin:0;font-size:1.1rem}
  .small{color:#6b7280}
  .bar{height:14px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar .fill{height:100%;background:linear-gradient(90deg,#22c55e,#16a34a)}
  .percent{font-weight:800;margin-top:6px;color:#111827}

  .levels h3{margin:16px 0 10px 0}
  .level-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
  .level-card{background:#fff;border-radius:12px;padding:12px 14px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
  .level-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .chip{background:#111827;color:#fff;border-radius:999px;padding:4px 10px;font-weight:700;font-size:12px}
  .mini{color:#6b7280;font-size:12px}
  .level-bar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin-bottom:8px}
  .level-bar .fill{height:100%;background:linear-gradient(90deg,#6366f1,#8b5cf6)}
  .btn.tiny{padding:6px 10px;border-radius:8px;font-size:12px;font-weight:800;text-decoration:none}
  .btn.ghost{background:#f3f4f6;color:#111;border:1px solid #e5e7eb}

  .modules h3{margin:18px 0 10px 0}
  .module-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
  .module-card{background:#fff;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.06);padding:14px}
  .module-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .badge.subtle{background:#f3f4f6;color:#111;border:1px solid #e5e7eb}
  .lesson-list{list-style:none;padding:0;margin:0;display:grid;gap:8px}
  .lesson-list li a{text-decoration:none;color:#111;font-weight:700}
  .lesson-list li a:hover{text-decoration:underline}
  .pill{display:inline-block;background:#e0f2fe;color:#0369a1;border-radius:999px;padding:2px 8px;font-size:12px;font-weight:800}
  .locked{color:#9ca3af}
  .muted{color:#6b7280}

  /* Ensure modal sits above any page overlays */
  .modal-backdrop { z-index: 1990 !important; }
  .modal { z-index: 2000 !important; }

  @media(max-width:768px){.hero-inner{padding:22px}}
</style>
<!-- close container opened at top of content block -->
</div>
{% endblock %}

{% block modals %}
  <div class="modal fade" id="testModal" tabindex="-1" aria-labelledby="testModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="testModalLabel">Modal de test</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Ceci est un modal de test sur la page du cours: {{ course.title }}.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
          <a href="{% url 'courses:all_courses' %}" class="btn btn-primary">Voir tous les cours</a>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
