{% extends "base.html" %}
{% block title %}{{ trainer.username }} - Chaîne{% endblock %}
{% block content %}
<style>
  :root{ --cover-h: 220px; }
  .chan-cover{position:relative;height:var(--cover-h);background:#0b0d17;border-radius:14px;overflow:hidden;margin-bottom:0}
  .chan-head{display:flex;align-items:center;gap:14px;padding:12px 8px}
  .chan-avatar{position:relative;width:72px;height:72px;border-radius:50%;overflow:hidden;border:3px solid #fff;box-shadow:0 8px 20px rgba(0,0,0,.2);background:#111827;margin-top:12px}
  .chan-name{font-weight:900;font-size:1.4rem}
  .chan-meta{color:#6b7280;font-size:.9rem}
  .chan-actions{margin-left:auto;display:flex;gap:8px}
  .chan-tabs{display:flex;gap:18px;border-bottom:1px solid #e5e7eb;margin-top:6px}
  .chan-tab{display:inline-block;padding:10px 2px;color:#111827;text-decoration:none;font-weight:700}
  .chan-tab.active{border-bottom:2px solid #111827}
  .grid-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
  .card-link{border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;background:#fff;text-decoration:none;color:inherit}
  .card-media{position:relative;height:150px;background:#0b1220}
  .card-fallback{position:absolute;inset:0;display:grid;place-items:center;color:#fff;font-weight:800;font-size:42px}
  .chan-avatar .card-fallback{font-size:28px}
  .badge-muted{font-size:12px;color:#6b7280;margin-bottom:4px}
  .btn-subscribe{transition:all .2s}
  .btn-subscribe:hover{transform:translateY(-1px)}
  .live-badge{display:inline-block;background:#ef4444;color:#fff;font-weight:900;border-radius:999px;padding:2px 8px;font-size:11px}
  .rating{display:inline-flex;align-items:center;gap:6px;margin-top:4px}
  .stars{color:#f59e0b;font-size:14px;letter-spacing:1px}
  .tab-panel{display:none}
  .tab-panel.active{display:block}
  .cover-edit{position:absolute;right:10px;bottom:10px;z-index:2}
  .cover-edit .btn{backdrop-filter:saturate(140%) blur(2px)}
  .avatar-edit{position:absolute;right:-6px;bottom:-6px;background:#0b5ed7;color:#fff;border-radius:999px;border:2px solid #fff;width:22px;height:22px;display:grid;place-items:center;font-size:12px;box-shadow:0 6px 12px rgba(0,0,0,.25)}
  
  /* Styles pour le bouton FAB */
  .fab-button {
    position: fixed;
    right: 22px;
    top: 80px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    background: #0b5ed7;
    color: #fff;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1001;
    transition: transform 0.2s ease, background-color 0.2s ease;
    cursor: pointer;
  }
  
  .fab-button:hover {
    transform: scale(1.1);
    background: #0a58ca;
  }
  
  /* Styles pour la modal FAB */
  .fab-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1002;
    opacity: 0;
    transition: opacity 0.2s ease;
  }
  
  .fab-modal.show {
    opacity: 1;
  }
  
  .fab-modal > div {
    background: #fff;
    border-radius: 12px;
    min-width: 320px;
    max-width: 92vw;
    padding: 14px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  }
</style>

<div class="container px-0">
  <section class="chan-cover">
    {% if trainer.cover %}
      <img src="{{ trainer.cover.url }}" alt="cover" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:.85;">
    {% else %}
      <div style="position:absolute;inset:0;background:linear-gradient(135deg,#0f172a,#1f2937);"></div>
    {% endif %}
    {% if request.user.is_authenticated and request.user.id == trainer.id or request.user.is_authenticated and request.user.is_superuser %}
      <div class="cover-edit">
        <form id="cover-form" method="post" action="{% url 'users:upload_cover' %}" enctype="multipart/form-data" style="display:inline-block;">
          {% csrf_token %}
          <input id="cover-input" type="file" name="cover" accept="image/*" style="display:none;">
          <button id="cover-btn" type="button" class="btn btn-sm btn-light">Modifier la couverture</button>
        </form>
      </div>
    {% endif %}
  </section>
  <section class="chan-head container">
    <div class="chan-avatar">
      {% with avatar_display=trainer.get_avatar_display %}
        {% if avatar_display.type == 'image' %}
          <img src="{{ avatar_display.url }}" alt="{{ avatar_display.alt }}" style="width:100%;height:100%;object-fit:cover;">
        {% else %}
          <div class="card-fallback" style="background: {{ avatar_display.bg_color }}; color: {{ avatar_display.color }}; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold;">
            {{ avatar_display.initial }}
          </div>
        {% endif %}
      {% endwith %}
      {% if request.user.is_authenticated and request.user.id == trainer.id or request.user.is_authenticated and request.user.is_superuser %}
        <form id="avatar-form" method="post" action="{% url 'users:upload_avatar' %}" enctype="multipart/form-data" style="display:none;">
          {% csrf_token %}
          <input id="avatar-input" type="file" name="avatar" accept="image/*">
        </form>
        <label for="avatar-input" class="avatar-edit" title="Modifier la photo de profil">
          <i class="bi bi-camera"></i>
        </label>
      {% endif %}
    </div>
    <div>
      <div class="chan-name">{{ trainer.username }}</div>
      <div class="rating">
        <span class="stars" data-rating="{{ trainer.rating|default:0 }}">★★★★★</span>
        <span class="chan-meta">(<span class="rating-value">{{ trainer.rating|default:0 }}</span>) • {{ stats.courses }} cours publiés</span>
      </div>
      <div class="abonnés">
        <div class="text-muted" style="font-size:12px;">Abonnés</div>    
        <div style="font-weight:900;font-size:20px;" class="subscribers-count">{{ subscribers_count }}</div>
      </div>
    </div>
    <div class="chan-actions">
      {% if user != trainer%}
      <a class="btn btn-sm btn-outline-dark me-2" href="#about">À propos</a>
      {% endif %}
      {% if user.is_authenticated and user != trainer%}
      <button class="btn btn-sm btn-{{ is_subscribed|yesno:'outline-danger,primary' }} btn-subscribe me-2" 
              id="subscribe-button"
              data-username="{{ trainer.username }}">
        <i class="fas fa-{{ is_subscribed|yesno:'user-minus,user-plus' }} me-1"></i>
        {{ is_subscribed|yesno:'Se désabonner,S\'abonner' }}
      </button>
      {% endif %}
      {% if user.is_authenticated and user == trainer %}
      <a href="{% url 'subscriptions:my_subscribers' %}" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-users me-1"></i>
        <span class="subscribers-count">{{ subscribers_count|default:0 }}</span> abonnés
      </a>
      {% endif %}
    </div>
  </section>
  
  <!-- Barre de recherche des formateurs -->
  <!-- {% if not from_search %}
  <div class="container mb-4">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="input-group">
          <input type="text" id="search-trainers" class="form-control" placeholder="Rechercher un formateur...">
          <button class="btn btn-primary" type="button" id="search-button">
            <i class="fas fa-search"></i> Rechercher
          </button>
        </div>
        <div id="search-results" class="mt-3" style="display:none;">
          <div class="list-group"> -->
            <!-- Les résultats de la recherche seront affichés ici -->
          <!-- </div>
        </div>
      </div>
    </div>
  </div> -->
  {% endif %}
  
  <ul class="nav nav-tabs container" role="tablist" style="margin:6px 0 14px 0; font-size:0; line-height:0">
    <li class="nav-item" role="presentation">
      <a class="nav-link active" data-bs-toggle="tab" href="#accueil" role="tab" aria-controls="accueil" aria-selected="true" style="font-size:1rem; line-height:1.25">Accueil</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" data-bs-toggle="tab" href="#videos" role="tab" aria-controls="videos" aria-selected="false" style="font-size:1rem; line-height:1.25">Vidéos</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" data-bs-toggle="tab" href="#lives" role="tab" aria-controls="lives" aria-selected="false" style="font-size:1rem; line-height:1.25">Lives</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" data-bs-toggle="tab" href="#about" role="tab" aria-controls="about" aria-selected="false" style="font-size:1rem; line-height:1.25">À propos</a>
    </li>
    {% if request.user == trainer %}
    <li class="nav-item ms-auto d-flex align-items-center" role="presentation">
      <a href="{% url 'interactions:inbox' %}" class="nav-link position-relative" style="font-size:1rem; line-height:1.25">
        <i class="fas fa-envelope me-1"></i> Messages
        {% if unread_count %}
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size:0.6rem">
            {{ unread_count }}
            <span class="visually-hidden">messages non lus</span>
          </span>
        {% endif %}
      </a>
    </li>
    {% endif %}
  </ul>

  <div class="tab-content">
  <section id="accueil" class="container tab-pane fade show active" style="padding-top:12px">
    <!-- En-tête du profil avec bouton de suivi -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <!-- <div class="d-flex align-items-center gap-3">
        <div class="position-relative">
          {% with avatar_display=trainer.get_avatar_display %}
            {% if avatar_display.type == 'image' %}
              <img src="{{ avatar_display.url }}" 
                   class="rounded-circle" width="80" height="80" alt="{{ avatar_display.alt }}">
            {% else %}
              <div class="rounded-circle d-flex align-items-center justify-content-center" 
                   style="width:80px; height:80px; background:{{ avatar_display.bg_color }}; color:{{ avatar_display.color }}; font-size: 2rem; font-weight: bold;">
                {{ avatar_display.initial }}
              </div>
            {% endif %}
          {% endwith %}
        </div>
        <div>
          <h1 class="h4 mb-0">{{ trainer.get_full_name|default:trainer.username }}</h1>
        </div>
      </div> -->   
      <!-- {% if user.is_authenticated and user != trainer %}
        <button class="btn btn-{{ is_subscribed|yesno:'outline-danger,primary' }} btn-subscribe" 
                id="subscribe-button"
                data-username="{{ trainer.username }}">
          <i class="fas fa-{{ is_subscribed|yesno:'user-minus,user-plus' }} me-1"></i>
          {{ is_subscribed|yesno:'Se désabonner,S\'abonner' }}
        </button>
      {% endif %}
    -->
    </div>

    <div class="row" style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:12px;">
      <div class="card" style="flex:1;min-width:180px;padding:12px;border:1px solid #e5e7eb;border-radius:10px;">
        <div class="text-muted" style="font-size:12px;">Cours publiés</div>
        <div style="font-weight:900;font-size:20px;">{{ stats.courses }}</div>
      </div>
      <div class="card" style="flex:1;min-width:180px;padding:12px;border:1px solid #e5e7eb;border-radius:10px;">
        <div class="text-muted" style="font-size:12px;">Lives à venir</div>
        <div style="font-weight:900;font-size:20px;">{% if upcoming_sessions %}{{ upcoming_sessions|length }}{% else %}0{% endif %}</div>
      </div>
      <div class="card" style="flex:1;min-width:180px;padding:12px;border:1px solid #e5e7eb;border-radius:10px;">
        <div class="text-muted" style="font-size:12px;">Abonnés</div>
        <div style="font-weight:900;font-size:20px;" class="subscribers-count">{{ subscribers_count }}</div>
      </div>
    </div>
    <h5 style="font-weight:900;margin-bottom:8px;">Cours récents</h5>
    <div class="grid-cards">
      {% for c in courses %}
        <a class="card-link" href="{% url 'courses:course_detail' c.id %}">
          <div class="card-media">
            {% if c.thumbnail %}
              <img src="{{ c.thumbnail.url }}" alt="{{ c.title }}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;"/>
            {% else %}
              <div class="card-fallback">{{ c.title|first|upper }}</div>
            {% endif %}
          </div>
          <div class="card-body">
            <div class="badge-muted">{{ c.category.name|default:'Général' }}</div>
            <div style="font-weight:800;">{{ c.title }}</div>
          </div>
        </a>
      {% empty %}
        <div class="text-muted">Aucun cours publié.</div>
      {% endfor %}
    </div>
  </section>

  <section id="lives" class="container tab-pane fade" style="padding-top:12px">
    <h5 style="font-weight:900;margin:14px 0 8px 0;">Sessions à venir</h5>
    {% if upcoming_sessions %}
    <div class="grid-cards">
      {% for s in upcoming_sessions %}
        <a class="card-link" href="{% url 'classrooms:detail' s.classroom.id %}">
          <div class="card-media" style="display:grid;place-items:center;">
            <span class="live-badge">LIVE</span>
          </div>
          <div class="card-body">
            <div class="badge-muted">{{ s.classroom.name }}</div>
            <div style="font-weight:800;">{{ s.title }}</div>
            <div class="badge-muted">{{ s.start_at|date:"d/m H:i" }}</div>
          </div>
        </a>
      {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">Aucune session à venir pour le moment.</div>
    {% endif %}
  </section>

  <section id="videos" class="container tab-pane fade" style="padding-top:12px">
    <h5 style="font-weight:900;margin:14px 0 8px 0;">Toutes les vidéos ({{ videos|length }})</h5>
    <div class="row g-3">
      {% for video in videos %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <a class="card-link" href="{% url 'courses:lesson_detail' video.lesson_id %}">
            <div class="card h-100" style="border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
              <div class="position-relative" style="padding-bottom: 56.25%;">
                {% if video.thumbnail_url %}
                  <img src="{{ video.thumbnail_url }}" alt="{{ video.title }}" class="w-100 h-100" style="position: absolute; object-fit: cover;">
                  <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background-color: rgba(0,0,0,0.3);">
                    <i class="fas fa-play-circle" style="font-size: 3rem; color: rgba(255,255,255,0.9);"></i>
                  </div>
                {% else %}
                  <div class="bg-light d-flex align-items-center justify-content-center" style="height: 100%;">
                    <i class="fas fa-play-circle" style="font-size: 3rem; color: #6c757d;"></i>
                  </div>
                {% endif %}
                {% if video.duration %}
                  <span class="badge bg-dark position-absolute" style="bottom: 8px; right: 8px; font-size: 0.75rem;">
                    {{ video.duration }}
                  </span>
                {% endif %}
              </div>
              <div class="card-body p-3">
                <h6 class="card-title mb-1 text-truncate" style="font-weight: 600; font-size: 0.95rem;">{{ video.title }}</h6>
                <p class="text-muted small mb-2" style="font-size: 0.8rem;">{{ video.course_title }}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <small class="text-muted">
                    <i class="far fa-calendar-alt me-1"></i>
                    {{ video.created_at|date:"d/m/Y" }}
                  </small>
                </div>
              </div>
            </div>
          </a>
        </div>
      {% empty %}
        <div class="col-12">
          <div class="text-center py-5">
            <i class="fas fa-video-slash mb-3" style="font-size: 2.5rem; color: #dee2e6;"></i>
            <p class="text-muted">Aucune vidéo disponible pour le moment.</p>
          </div>
        </div>
      {% endfor %}
    </div>
  </section>

  <section id="about" class="container tab-pane fade" style="padding-top:12px">
    <h5 style="font-weight:900;margin:14px 0 8px 0;">À propos</h5>
    <div class="card" style="padding:12px;border:1px solid #e5e7eb;border-radius:10px;">
      <div class="mb-3">
        <h6 class="mb-2">À propos du formateur</h6>
        <p class="mb-1">Nom d'utilisateur: {{ trainer.username }}</p>
        {% if trainer.first_name or trainer.last_name %}
        <p class="mb-1">Nom complet: {{ trainer.get_full_name }}</p>
        {% endif %}
        {% if trainer.email %}
        <p class="mb-1">Email: {{ trainer.email }}</p>
        {% endif %}
        <p class="mb-0">Date d'inscription: {{ trainer.date_joined|date:"d/m/Y" }}</p>
      </div>
      <div class="text-muted">
      <div class="text-muted">Cours publiés: {{ stats.courses }}</div>
    </div>
  </section>

  {% if request.user.is_authenticated and request.user.id == trainer.id or request.user.is_authenticated and request.user.is_superuser %}
  <button id="fab-plus" class="fab-button" aria-label="Créer" title="Créer">+</button>
  <div id="fab-modal" class="fab-modal">
    <div style="background:#fff;border-radius:12px;width:36vw;padding:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div style="font-weight:900;">Actions rapides</div>
        <button id="fab-close" class="btn btn-sm btn-outline-dark">Fermer</button>
      </div>
      <div style="display:grid;gap:10px;">
        <button id="btn-open-course-modal" class="btn btn-primary" type="button">Créer un cours</button>
        <a class="btn btn-outline-primary" href="{% url 'classrooms:create' %}">Créer une salle de classe</a>
        <a class="btn btn-outline-dark" href="{% url 'courses:manage' %}">Gérer mes cours</a>
        <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#selectLessonModal">Ajouter un exercice</button>
        <hr/>
        <div class="text-muted" style="font-size:.9rem;">Accès direct</div>
        <div class="row g-2">
          <div class="col-12">
            <label class="form-label">Cours</label>
            <select id="fab-course" class="form-select">
              <option value="">— choisir —</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">Module</label>
            <select id="fab-module" class="form-select" disabled>
              <option value="">— choisir —</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">Leçon</label>
            <select id="fab-lesson" class="form-select" disabled>
              <option value="">— choisir —</option>
            </select>
          </div>
          <div class="col-12 d-flex flex-wrap gap-2">
            <button id="fab-go-create-module" class="btn btn-dark" disabled>Créer un module</button>
            <button id="fab-go-create-lesson" class="btn btn-primary" disabled>Créer une leçon</button>
            <button id="fab-go-add-video" class="btn btn-outline-primary" disabled>Ajouter une vidéo</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  <!-- Modals: Course / Module / Lesson / Video -->
  <div aria-live="polite" aria-atomic="true" class="position-fixed" style="right:16px;bottom:16px;z-index:1080">
    <div id="toast-wrap"></div>
  </div>
  <div class="modal fade" id="createCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Créer un nouveau cours</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="post" action="{% url 'courses:course_create' %}" id="createCourseForm" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="modal-body">
            {% if messages %}
            <div class="mb-3">
              {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            </div>
            {% endif %}
            
            <div class="mb-3">
              <label for="id_title" class="form-label">Titre du cours</label>
              <input type="text" name="title" class="form-control" id="id_title" required>
              {% if form.title.errors %}
                <div class="text-danger small mt-1">
                  {{ form.title.errors }}
                </div>
              {% endif %}
            </div>
            
            <div class="mb-3">
              <label for="id_description" class="form-label">Description</label>
              <textarea name="description" class="form-control" id="id_description" rows="4"></textarea>
              {% if form.description.errors %}
                <div class="text-danger small mt-1">
                  {{ form.description.errors }}
                </div>
              {% endif %}
            </div>
            
            <div class="mb-3">
              <label for="id_category" class="form-label">Catégorie</label>
              <select name="category" class="form-select" id="courseCategorySelect" required>
                <option value="" disabled selected>Sélectionnez une catégorie</option>
                {% for category in categories %}
                <option value="{{ category.id }}">
                  {{ category.name }}
                </option>
                {% endfor %}
              </select>
              <div class="form-text">
                <a href="#" id="addCategoryBtn" class="text-primary">
                  <i class="fas fa-plus-circle"></i> Ajouter une nouvelle catégorie
                </a>
              </div>
              {% if form.category.errors %}
                <div class="text-danger small mt-1">
                  {{ form.category.errors }}
                </div>
              {% endif %}
            </div>
            
            <div class="mb-4">
              <label for="id_language" class="form-label">Langue</label>
              <select name="language" class="form-select" id="id_language" required>
                <option value="fr" selected>Français</option>
                <option value="en">English</option>
              </select>
              {% if form.language.errors %}
                <div class="text-danger small mt-1">
                  {{ form.language.errors }}
                </div>
              {% endif %}
            </div>
            
            <div class="mb-3">
              <label for="id_thumbnail" class="form-label">Image de couverture</label>
              <input type="file" name="thumbnail" class="form-control" id="id_thumbnail" accept="image/*">
              <div class="form-text">Format recommandé : 1280x720px. Taille maximale : 2MB.</div>
              {% if form.thumbnail.errors %}
                <div class="text-danger small mt-1">
                  {{ form.thumbnail.errors }}
                </div>
              {% endif %}
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i> Annuler
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-1"></i> Créer le cours
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modal-module" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Créer un module</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <form id="form-module" method="post">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-2"><label class="form-label">Titre</label><input class="form-control" name="title" required></div>
            <div class="mb-2"><label class="form-label">Description</label><textarea class="form-control" name="description" rows="3"></textarea></div>
            <div class="mb-2"><label class="form-label">Niveau</label>
              <select class="form-select" name="level">
                <option value="beginner">Débutant</option>
                <option value="intermediate">Intermédiaire</option>
                <option value="advanced">Avancé</option>
              </select>
            </div>
            <div class="mb-2"><label class="form-label">Ordre</label><input type="number" class="form-control" name="order" value="1" min="1"></div>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <div>
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
              <button type="submit" class="btn btn-dark">Créer</button>
            </div>
            <div>
              {% if course.id and module.id %}
                <a href="{% url 'courses:lesson_create' course.id module.id %}" class="btn btn-primary">
                  <i class="fas fa-plus me-1"></i> Ajouter une leçon
                </a>
              {% endif %}
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modal-lesson" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Créer une leçon</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <form id="form-lesson" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-2"><label class="form-label">Titre</label><input class="form-control" name="title" required></div>
            <div class="mb-2"><label class="form-label">Description</label><textarea class="form-control" name="description" rows="3"></textarea></div>
            <div class="mb-2"><label class="form-label">Fichier contenu</label><input type="file" class="form-control" name="content_file"></div>
            <div class="mb-2"><label class="form-label">Fichier vidéo</label><input type="file" class="form-control" name="video_file" accept="video/*"></div>
            <div class="mb-2"><label class="form-label">Ordre</label><input type="number" class="form-control" name="order" value="1" min="1"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-primary">Créer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modal-video" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Ajouter une vidéo</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <form id="form-video" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-2"><label class="form-label">Titre (optionnel)</label><input class="form-control" name="title"></div>
            <div class="mb-2"><label class="form-label">Fichier vidéo</label><input type="file" class="form-control" name="video_file" accept="video/*" required></div>
            <div class="mb-2"><label class="form-label">Ordre</label><input type="number" class="form-control" name="order" value="1" min="1"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-outline-primary">Ajouter</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script>
    // Fonction de recherche des formateurs
    function searchTrainers(query) {
      if (query.length < 2) {
        $('#search-results').hide();
        return;
      }
      
      $.ajax({
        url: '{% url "users:search_trainers" %}',
        data: { 'q': query },
        dataType: 'json',
        success: function(data) {
          const resultsContainer = $('#search-results .list-group');
          resultsContainer.empty();
          
          if (data.trainers && data.trainers.length > 0) {
            data.trainers.forEach(function(trainer) {
              const isSubscribed = trainer.is_subscribed || false;
              const buttonClass = isSubscribed ? 'btn-outline-danger' : 'btn-primary';
              const buttonText = isSubscribed ? 'Se désabonner' : 'S\'abonner';
              const buttonIcon = isSubscribed ? 'user-minus' : 'user-plus';
              
              const trainerHtml = `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <img src="${trainer.avatar || '/static/images/default-avatar.png'}" 
                         class="rounded-circle me-2" width="40" height="40" alt="${trainer.username}">
                    <div>
                      <h6 class="mb-0">${trainer.full_name || trainer.username}</h6>
                      <small class="text-muted">${trainer.courses_count || 0} cours publiés • ${trainer.subscribers_count || 0} abonnés</small>
                    </div>
                  </div>
                  <button class="btn btn-sm ${buttonClass} btn-subscribe" 
                          data-username="${trainer.username}"
                          data-subscribed="${isSubscribed}">
                    <i class="fas fa-${buttonIcon} me-1"></i> ${buttonText}
                  </button>
                </div>`;
              resultsContainer.append(trainerHtml);
            });
            $('#search-results').show();
          } else {
            resultsContainer.html('<div class="list-group-item text-muted">Aucun formateur trouvé</div>');
            $('#search-results').show();
          }
        }
      });
    }

    // Gestion de la recherche lors de la frappe (avec délai)
    let searchTimeout;
    $('#search-trainers').on('input', function() {
      clearTimeout(searchTimeout);
      const query = $(this).val().trim();
      searchTimeout = setTimeout(() => searchTrainers(query), 300);
    });

    // Gestion du clic sur le bouton de recherche
    $('#search-button').on('click', function() {
      const query = $('#search-trainers').val().trim();
      searchTrainers(query);
    });

    // Gestion des abonnements dans les résultats de recherche
    $(document).on('click', '#search-results .btn-subscribe', function() {
      const button = $(this);
      const username = button.data('username');
      const isSubscribed = button.data('subscribed');
      const action = isSubscribed ? 'unsubscribe' : 'subscribe';
      
      $.ajax({
        url: `/users/${username}/${action}/`,
        method: 'POST',
        headers: { 'X-CSRFTTOKEN': '{{ csrf_token }}' },
        success: function(response) {
          if (response.success) {
            const newState = !isSubscribed;
            button.data('subscribed', newState);
            button.toggleClass('btn-primary btn-outline-danger');
            button.html(`<i class="fas fa-user-${newState ? 'minus' : 'plus'} me-1"></i> ${newState ? 'Se désabonner' : 'S\'abonner'}`);
            
            // Mise à jour du compteur d'abonnés si on est sur le profil du formateur
            if (window.location.pathname.includes(username)) {
              const countElement = $('.subscribers-count');
              const currentCount = parseInt(countElement.text()) || 0;
              countElement.text(newState ? currentCount + 1 : Math.max(0, currentCount - 1));
            }
          }
        },
        error: function() {
          alert('Une erreur est survenue. Veuillez réessayer.');
        }
      });
    });

    // Gestion des abonnements
    console.log('=== Script de gestion des abonnements chargé ===');
    
    function updateSubscriptionUI(button, isSubscribed, count = null) {
      console.log('Mise à jour de l\'UI avec isSubscribed =', isSubscribed);
      button.innerHTML = `
        <i class="fas fa-${isSubscribed ? 'user-minus' : 'user-plus'} me-1"></i>
        ${isSubscribed ? 'Se désabonner' : 'S\'abonner'}
      `;
      button.classList.toggle('btn-primary', !isSubscribed);
      button.classList.toggle('btn-outline-danger', isSubscribed);
      
      if (count !== null) {
        document.querySelectorAll('.subscribers-count').forEach(el => {
          el.textContent = count;
        });
      }
    }
    
    function handleSubscription() {
      console.log('=== Gestionnaire d\'abonnement déclenché ===');
      const subscribeButton = document.getElementById('subscribe-button');
      
      if (!subscribeButton) {
        console.error('ERREUR: Le bouton d\'abonnement n\'a pas été trouvé dans le DOM');
        return;
      }
      
      console.log('Bouton d\'abonnement trouvé:', subscribeButton);
      
      // D'abord, supprimer tous les écouteurs d'événements existants
      const newButton = subscribeButton.cloneNode(true);
      subscribeButton.parentNode.replaceChild(newButton, subscribeButton);
      
      // Ajouter le nouvel écouteur d'événements
      newButton.addEventListener('click', async function(e) {
        e.preventDefault();
        console.log('=== Clic sur le bouton d\'abonnement ===');
        
        const username = this.dataset.username;
        if (!username) {
          console.error('ERREUR: Aucun nom d\'utilisateur trouvé dans data-username');
          return;
        }
        
        console.log('Nom d\'utilisateur du formateur:', username);
        const isCurrentlySubscribed = this.classList.contains('btn-outline-danger');
        console.log('Actuellement abonné:', isCurrentlySubscribed);
        
        // Désactiver le bouton pendant la requête
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Traitement...';
        
        try {
          console.log('Envoi de la requête à /subscriptions/toggle/' + username + '/');
          const response = await fetch(`/subscriptions/toggle/${username}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}',
              'X-Requested-With': 'XMLHttpRequest',
              'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
          })
          console.log('Réponse brute reçue:', response);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('Erreur HTTP:', response.status, errorText);
            throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
          }
          
          // Analyser la réponse JSON
          const data = await response.json();
          console.log('Données de la réponse:', data);
          
          // Mettre à jour l'interface utilisateur avec la réponse
          if (data.status === 'subscribed' || data.status === 'unsubscribed') {
            const isSubscribed = data.status === 'subscribed';
            updateSubscriptionUI(this, isSubscribed, data.subscribers_count);
            
            // Afficher un message de confirmation
            const message = isSubscribed ? 'Abonnement réussi !' : 'Désabonnement réussi';
            console.log(message);
            
            if (typeof showToast === 'function') {
              showToast(message, 'success');
            } else {
              alert(message);
            }
          }
        } catch (error) {
          console.error('Erreur lors de l\'abonnement:', error);
          
          // Réactiver le bouton en cas d'erreur
          updateSubscriptionUI(this, !this.classList.contains('btn-outline-danger'));
          
          if (typeof showToast === 'function') {
            showToast('Erreur: ' + (error.message || 'Une erreur est survenue'), 'error');
          } else {
            alert('Erreur: ' + (error.message || 'Une erreur est survenue'));
          }
        } finally {
          // Réactiver le bouton dans tous les cas
          this.disabled = false;
        }
      });
    }
    
    // Initialiser immédiatement si le DOM est déjà chargé
    function initialize() {
      console.log('=== Initialisation du gestionnaire d\'abonnement ===');
      handleSubscription();
      
      // Vérifier périodiquement si le bouton a été ajouté dynamiquement
      const checkInterval = setInterval(() => {
        const button = document.getElementById('subscribe-button');
        if (button && !button.dataset.initialized) {
          console.log('Bouton détecté dynamiquement, réinitialisation...');
          button.dataset.initialized = 'true';
          handleSubscription();
        }
      }, 1000);
      
      // Nettoyer l'intervalle si la page est déchargée
      window.addEventListener('beforeunload', () => clearInterval(checkInterval));
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      setTimeout(initialize, 500); // Petit délai pour s'assurer que tout est chargé
    }

    // Initialisation du FAB
    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== Initialisation du FAB ===');
      const fab = document.getElementById('fab-plus');
      const modal = document.getElementById('fab-modal');
      const closeBtn = document.getElementById('fab-close');
      
      console.log('Éléments trouvés:', { fab, modal, closeBtn });
      
      if (!fab || !modal || !closeBtn) {
        console.error('ERREUR: Éléments FAB introuvables');
        if (!fab) console.error('Le bouton FAB (fab-plus) est introuvable');
        if (!modal) console.error('La modal FAB (fab-modal) est introuvable');
        if (!closeBtn) console.error('Le bouton de fermeture (fab-close) est introuvable');
        return;
      }
      
      console.log('Tous les éléments FAB sont présents');
      
      // Fonction pour afficher la modal
      function showModal() {
        console.log('showModal() appelée');
        console.log('État avant affichage:', {
          display: modal.style.display,
          classList: modal.className,
          computedDisplay: window.getComputedStyle(modal).display
        });
        
        modal.style.display = 'flex';
        console.log('Affichage de la modal');
        
        setTimeout(() => { 
          console.log('Ajout de la classe show');
          modal.classList.add('show'); 
          
          // Vérification après l'animation
          console.log('État après animation:', {
            display: modal.style.display,
            classList: modal.className,
            computedDisplay: window.getComputedStyle(modal).display,
            computedOpacity: window.getComputedStyle(modal).opacity
          });
        }, 10);
      }
      
      // Fonction pour masquer la modal
      function hideModal() {
        modal.classList.remove('show');
        setTimeout(() => { modal.style.display = 'none'; }, 200);
      }
      
      // Gestion des événements
      console.log('Ajout des écouteurs d\'événements...');
      
      fab.addEventListener('click', function(e) {
        console.log('Clic sur le bouton FAB détecté');
        e.stopPropagation();
        console.log('Appel de showModal()');
        showModal();
      });
      
      // Vérification du style du bouton
      console.log('Styles du bouton FAB:', {
        display: window.getComputedStyle(fab).display,
        visibility: window.getComputedStyle(fab).visibility,
        opacity: window.getComputedStyle(fab).opacity,
        pointerEvents: window.getComputedStyle(fab).pointerEvents,
        position: window.getComputedStyle(fab).position,
        zIndex: window.getComputedStyle(fab).zIndex
      });
      
      closeBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        hideModal();
      });
      
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          hideModal();
        }
      });
      
      // Empêcher la fermeture lors du clic dans la modal
      const modalContent = modal.querySelector('div:first-child');
      if (modalContent) {
        modalContent.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      }

      // Make avatar clickable if owner
      const avatarForm = document.getElementById('avatar-form');
      const avatarInput = document.getElementById('avatar-input');
      const avatar = document.querySelector('.chan-avatar');
      if(avatarForm && avatarInput && avatar){
        avatar.classList.add('clickable');
        avatar.addEventListener('click', ()=> avatarInput.click());
        avatarInput.addEventListener('change', ()=> { if(avatarInput.files?.length){ avatarForm.submit(); } });
      }

      // Stars rendering
      document.querySelectorAll('.stars').forEach(el=>{
        const val = parseFloat(el.getAttribute('data-rating')) || 0;
        const full = Math.floor(val);
        const half = val - full >= 0.5;
        const stars = Array.from({length:5}, (_,i)=> i<full ? '★' : (i===full && half ? '☆' : '☆')).join('');
        el.textContent = stars;
      });

      // Cover upload trigger (owner only)
      const coverBtn = document.getElementById('cover-btn');
      const coverInput = document.getElementById('cover-input');
      const coverForm = document.getElementById('cover-form');
      coverBtn?.addEventListener('click', ()=> coverInput?.click());
      coverInput?.addEventListener('change', ()=> { if(coverInput.files?.length){ coverForm?.submit(); } });

      // FAB selector logic (trainer only)
      async function fetchJSON(url){ const r = await fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
      const selCourse = document.getElementById('fab-course');
      const selModule = document.getElementById('fab-module');
      const selLesson = document.getElementById('fab-lesson');
      const btnCreateModule = document.getElementById('fab-go-create-module');
      const btnCreateLesson = document.getElementById('fab-go-create-lesson');
      const btnAddVideo = document.getElementById('fab-go-add-video');
      const btnOpenCourse = document.getElementById('btn-open-course-modal');
      let mCourse=null, mModule=null, mLesson=null, mVideo=null;
      try{
        if(window.bootstrap && bootstrap.Modal){
          mCourse = new bootstrap.Modal(document.getElementById('modal-course'));
          mModule = new bootstrap.Modal(document.getElementById('modal-module'));
          mLesson = new bootstrap.Modal(document.getElementById('modal-lesson'));
          mVideo = new bootstrap.Modal(document.getElementById('modal-video'));
        }
      }catch(_){/* ignore */}
      const fModule = document.getElementById('form-module');
      const fLesson = document.getElementById('form-lesson');
      const fVideo = document.getElementById('form-video');
      let coursesLoaded = false;
      async function reloadCourses(){
        if(!selCourse) return;
        const current = selCourse.value;
        selCourse.innerHTML = '<option value="">— choisir —</option>';
        try{
          const data = await fetchJSON('{% url "courses:api_my_courses" %}');
          (data.courses||[]).forEach(c=>{ const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.title; selCourse.appendChild(opt); });
          if(current){ selCourse.value = current; }
        }catch(_){/* ignore */}
      }
      async function reloadModules(){
        if(!selModule || !selCourse.value) return;
        const current = selModule.value;
        selModule.innerHTML = '<option value="">— choisir —</option>';
        try{
          const data = await fetchJSON('{% url "courses:api_modules_for_course" 0 %}'.replace('/0/','/'+selCourse.value+'/'));
          (data.modules||[]).forEach(m=>{ const opt=document.createElement('option'); opt.value=m.id; opt.textContent=m.title; selModule.appendChild(opt); });
          if(current){ selModule.value = current; }
        }catch(_){/* ignore */}
      }
      async function reloadLessons(){
        if(!selLesson || !selModule.value) return;
        const current = selLesson.value;
        selLesson.innerHTML = '<option value="">— choisir —</option>';
        try{
          const data = await fetchJSON('{% url "courses:api_lessons_for_module" 0 %}'.replace('/0/','/'+selModule.value+'/'));
          (data.lessons||[]).forEach(l=>{ const opt=document.createElement('option'); opt.value=l.id; opt.textContent=l.title; selLesson.appendChild(opt); });
          if(current){ selLesson.value = current; }
        }catch(_){/* ignore */}
      }
      function showToast(msg){
        try{
          const wrap = document.getElementById('toast-wrap');
          if(!wrap || !window.bootstrap) return;
          const el = document.createElement('div');
          el.className = 'toast align-items-center text-bg-dark border-0';
          el.setAttribute('role','status'); el.setAttribute('aria-live','polite'); el.setAttribute('aria-atomic','true');
          el.innerHTML = '<div class="d-flex"><div class="toast-body">'+(msg||'Action effectuée')+'</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>';
          wrap.appendChild(el);
          const t = new bootstrap.Toast(el, {delay: 2000}); t.show();
          el.addEventListener('hidden.bs.toast', ()=> el.remove());
        }catch(_){/* ignore */}
      }
      function openSub(modal, fallbackUrl){
        if(!modal){
          if(fallbackUrl && !/\/0(\/|$)/.test(fallbackUrl)){
            window.location.href = fallbackUrl;
          } else {
            alert('Sélection manquante. Veuillez choisir les éléments requis.');
          }
          return;
        }
        // hide big overlay to avoid stacking issues
        if(modal && modal._isShown !== true){
          modal._element.addEventListener('hidden.bs.modal', ()=>{ modal._isShown=false; modal._element?.removeEventListener('hidden.bs.modal', ()=>{}); modal=null; const wrap=document.getElementById('fab-modal'); if(wrap){ wrap.style.display='flex'; } }, {once:true});
          const wrap=document.getElementById('fab-modal'); if(wrap){ wrap.style.display='none'; }
          modal.show();
          modal._isShown = true;
        }
      }
      async function loadCourses(){
        if(coursesLoaded) return;
        try{
          const data = await fetchJSON('{% url "courses:api_my_courses" %}');
          (data.courses||[]).forEach(c=>{ const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.title; selCourse.appendChild(opt); });
          coursesLoaded = true;
        }catch(e){ /* ignore */ }
      }
      if(selCourse && selModule && selLesson){
        loadCourses();
        fab?.addEventListener('click', ()=>{ setTimeout(loadCourses, 0); });
        selCourse.addEventListener('change', async ()=>{
          selModule.innerHTML = '<option value="">— choisir —</option>';
          selLesson.innerHTML = '<option value="">— choisir —</option>';
          selModule.disabled = !selCourse.value;
          selLesson.disabled = true;
          btnCreateModule.disabled = !selCourse.value;
          btnCreateLesson.disabled = !selCourse.value; // activé après module choisi
          btnAddVideo.disabled = true;
          if(!selCourse.value) return;
          try{
            const data = await fetchJSON('{% url "courses:api_modules_for_course" 0 %}'.replace('/0/','/'+selCourse.value+'/'));
            (data.modules||[]).forEach(m=>{ const opt=document.createElement('option'); opt.value=m.id; opt.textContent=m.title; selModule.appendChild(opt); });
          }catch(e){ /* ignore */ }
        });
        selModule.addEventListener('change', async ()=>{
          selLesson.innerHTML = '<option value="">— choisir —</option>';
          selLesson.disabled = !selModule.value;
          btnCreateLesson.disabled = !selModule.value;
          btnAddVideo.disabled = true;
          if(!selModule.value) return;
          try{
            const data = await fetchJSON('{% url "courses:api_lessons_for_module" 0 %}'.replace('/0/','/'+selModule.value+'/'));
            (data.lessons||[]).forEach(l=>{ const opt=document.createElement('option'); opt.value=l.id; opt.textContent=l.title; selLesson.appendChild(opt); });
          }catch(e){ /* ignore */ }
        });
        selLesson.addEventListener('change', ()=>{ btnAddVideo.disabled = !selLesson.value; });
        btnOpenCourse?.addEventListener('click', ()=>{
          const fallback = '{% url "courses:course_create" %}';
          openSub(mCourse, fallback);
        });
        btnCreateModule?.addEventListener('click', ()=>{
          if(!selCourse.value){ alert('Choisissez un cours'); return; }
          fModule.action = '{% url "courses:module_create" 0 %}'.replace('/0/','/'+selCourse.value+'/');
          const fallback = fModule.action;
          openSub(mModule, fallback);
        });
        btnCreateLesson?.addEventListener('click', ()=>{
          if(!selCourse.value){ alert('Choisissez un cours'); return; }
          if(!selModule.value){ alert('Choisissez un module'); return; }
          // Redirection directe vers la création de leçon avec le bon préfixe
          window.location.href = `/accueil/${selCourse.value}/modules/${selModule.value}/lessons/create/`;
        });
        btnAddVideo?.addEventListener('click', ()=>{
          if(!selLesson.value){ alert('Choisissez une leçon'); return; }
          fVideo.action = '{% url "courses:lesson_video_create" 0 %}'.replace('/0/','/'+selLesson.value+'/');
          const fallback = fVideo.action;
          openSub(mVideo, fallback);
        });

        // AJAX submit to avoid navigation and refresh selectors
        const fCourse = document.getElementById('form-course');
        fCourse?.addEventListener('submit', async (ev)=>{
          ev.preventDefault(); showToast('Création du cours en cours...');
          const btn = fCourse.querySelector('button[type="submit"]'); btn?.setAttribute('disabled','true');
          try{ await fetch(fCourse.action, {method:'POST', body:new FormData(fCourse)}); }catch(_){/* ignore */}
          btn?.removeAttribute('disabled');
          // close modal and refresh courses
          document.getElementById('modal-course')?.dispatchEvent(new Event('hidden.bs.modal'));
          await reloadCourses();
        });
        fModule?.addEventListener('submit', async (ev)=>{
          ev.preventDefault(); showToast('Création du module en cours...');
          const btn = fModule.querySelector('button[type="submit"]'); btn?.setAttribute('disabled','true');
          try{ await fetch(fModule.action, {method:'POST', body:new FormData(fModule)}); }catch(_){/* ignore */}
          btn?.removeAttribute('disabled');
          document.getElementById('modal-module')?.dispatchEvent(new Event('hidden.bs.modal'));
          await reloadModules();
        });
        fLesson?.addEventListener('submit', async (ev)=>{
          ev.preventDefault(); showToast('Création de la leçon en cours...');
          const btn = fLesson.querySelector('button[type="submit"]'); btn?.setAttribute('disabled','true');
          try{ await fetch(fLesson.action, {method:'POST', body:new FormData(fLesson)}); }catch(_){/* ignore */}
          btn?.removeAttribute('disabled');
          document.getElementById('modal-lesson')?.dispatchEvent(new Event('hidden.bs.modal'));
          await reloadLessons();
        });
        fVideo?.addEventListener('submit', async (ev)=>{
          ev.preventDefault(); showToast('Ajout de la vidéo en cours...');
          const btn = fVideo.querySelector('button[type="submit"]'); btn?.setAttribute('disabled','true');
          try{ await fetch(fVideo.action, {method:'POST', body:new FormData(fVideo)}); }catch(_){/* ignore */}
          btn?.removeAttribute('disabled');
          document.getElementById('modal-video')?.dispatchEvent(new Event('hidden.bs.modal'));
        });

        // Reset forms and selections on modal close
        ['modal-course','modal-module','modal-lesson','modal-video'].forEach(id=>{
          const el = document.getElementById(id);
          el?.addEventListener('hidden.bs.modal', ()=>{
            const form = el.querySelector('form');
            try{ form?.reset(); }catch(_){/* ignore */}
            if(id==='modal-module' || id==='modal-lesson' || id==='modal-video'){
              // keep selections in the main selector; no change here
            }
          });
        });
      }
    });
  </script>
  
  <!-- Modal de sélection de leçon pour les exercices -->
  <div class="modal fade" id="selectLessonModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Sélectionnez une leçon</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Cours</label>
            <select id="exercise-course" class="form-select">
              <option value="">— choisir —</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Module</label>
            <select id="exercise-module" class="form-select" disabled>
              <option value="">— choisir —</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Leçon</label>
            <select id="exercise-lesson" class="form-select" disabled>
              <option value="">— choisir —</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button id="exercise-confirm-btn" type="button" class="btn btn-primary" disabled>Aller à la création</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Script pour gérer la sélection de leçon pour les exercices
    document.addEventListener('DOMContentLoaded', function() {
      const courseSelect = document.getElementById('exercise-course');
      const moduleSelect = document.getElementById('exercise-module');
      const lessonSelect = document.getElementById('exercise-lesson');
      const confirmBtn = document.getElementById('exercise-confirm-btn');
      
      // Charger les cours
      async function loadCoursesForExercise() {
        try {
          const response = await fetch('{% url "courses:api_my_courses" %}', {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          const data = await response.json();
          
          courseSelect.innerHTML = '<option value="">— choisir —</option>';
          data.courses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.id;
            option.textContent = course.title;
            courseSelect.appendChild(option);
          });
        } catch (error) {
          console.error('Erreur lors du chargement des cours:', error);
        }
      }
      
      // Charger les modules pour un cours
      async function loadModules(courseId) {
        try {
          const response = await fetch('{% url "courses:api_modules_for_course" 0 %}'.replace('/0/', '/' + courseId + '/'), {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          const data = await response.json();
          
          moduleSelect.innerHTML = '<option value="">— choisir —</option>';
          moduleSelect.disabled = false;
          
          (data.modules || []).forEach(module => {
            const option = document.createElement('option');
            option.value = module.id;
            option.textContent = module.title;
            moduleSelect.appendChild(option);
          });
        } catch (error) {
          console.error('Erreur lors du chargement des modules:', error);
        }
      }
      
      // Charger les leçons pour un module
      async function loadLessons(moduleId) {
        try {
          const response = await fetch('{% url "courses:api_lessons_for_module" 0 %}'.replace('/0/', '/' + moduleId + '/'), {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          const data = await response.json();
          
          lessonSelect.innerHTML = '<option value="">— choisir —</option>';
          lessonSelect.disabled = false;
          
          (data.lessons || []).forEach(lesson => {
            const option = document.createElement('option');
            option.value = lesson.id;
            option.textContent = lesson.title;
            lessonSelect.appendChild(option);
          });
        } catch (error) {
          console.error('Erreur lors du chargement des leçons:', error);
        }
      }
      
      // Écouteurs d'événements
      courseSelect.addEventListener('change', () => {
        const courseId = courseSelect.value;
        if (courseId) {
          loadModules(courseId);
        } else {
          moduleSelect.innerHTML = '<option value="">— choisir —</option>';
          moduleSelect.disabled = true;
          lessonSelect.innerHTML = '<option value="">— choisir —</option>';
          lessonSelect.disabled = true;
          confirmBtn.disabled = true;
        }
      });
      
      moduleSelect.addEventListener('change', () => {
        const moduleId = moduleSelect.value;
        if (moduleId) {
          loadLessons(moduleId);
        } else {
          lessonSelect.innerHTML = '<option value="">— choisir —</option>';
          lessonSelect.disabled = true;
          confirmBtn.disabled = true;
        }
      });
      
      // Gestion du clic sur le bouton de confirmation
      confirmBtn.addEventListener('click', (e) => {
        if (!lessonSelect.value) {
          e.preventDefault();
          return;
        }
        window.location.href = `/exercices/lesson/${lessonSelect.value}/exercise/new/`;
      });

      // Mettre à jour l'état du bouton de confirmation
      function updateConfirmButton() {
        const isEnabled = !!lessonSelect.value;
        confirmBtn.disabled = !isEnabled;
      }

      // Mettre à jour l'état du bouton quand une leçon est sélectionnée
      lessonSelect.addEventListener('change', updateConfirmButton);
      
      // Désactiver le comportement par défaut du lien
      confirmBtn.addEventListener('click', (e) => e.preventDefault());
      
      // Charger les cours au chargement de la page
      loadCoursesForExercise();
    });
    // Gestion du téléchargement de l'avatar et de la couverture
    document.addEventListener('DOMContentLoaded', function() {
      // Gestion du bouton de modification de la couverture
      const coverBtn = document.getElementById('cover-btn');
      const coverInput = document.getElementById('cover-input');
      const coverForm = document.getElementById('cover-form');
      
      // Gestion du clic sur le bouton de couverture
      if (coverBtn && coverInput) {
        coverBtn.addEventListener('click', function(e) {
          e.preventDefault();
          coverInput.click(); // Déclenche le clic sur l'input file
        });
      }
      
      // Gestion du changement de fichier de couverture
      if (coverInput && coverForm) {
        coverInput.addEventListener('change', function() {
          if (this.files && this.files[0]) {
            const formData = new FormData(coverForm);
            
            fetch(coverForm.action, {
              method: 'POST',
              body: formData,
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              }
            })
            .then(response => {
              if (response.ok) {
                return response.json();
              }
              throw new Error('Erreur lors du téléchargement de la couverture');
            })
            .then(data => {
              if (data.success) {
                window.location.reload();
              } else {
                alert('Erreur: ' + (data.message || 'Impossible de mettre à jour la couverture'));
              }
            })
            .catch(error => {
              console.error('Erreur:', error);
              alert('Une erreur est survenue lors du téléchargement de la couverture');
            });
          }
        });
      }

      // Gestion de l'avatar
      const avatarInput = document.getElementById('avatar-input');
      const avatarForm = document.getElementById('avatar-form');
      
      if (avatarInput && avatarForm) {
        avatarInput.addEventListener('change', function() {
          if (this.files && this.files[0]) {
            const formData = new FormData(avatarForm);
            
            fetch(avatarForm.action, {
              method: 'POST',
              body: formData,
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              }
            })
            .then(response => {
              if (response.ok) {
                return response.json();
              }
              throw new Error('Erreur lors du téléchargement de l\'avatar');
            })
            .then(data => {
              if (data.success) {
                // Recharger la page pour afficher le nouvel avatar
                window.location.reload();
              } else {
                alert('Erreur: ' + (data.message || 'Impossible de mettre à jour l\'avatar'));
              }
            })
            .catch(error => {
              console.error('Erreur:', error);
              alert('Une erreur est survenue lors du téléchargement de l\'avatar');
            });
          }
        });
      }
    });
  </script>

  <!-- Initialisation des onglets Bootstrap -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Activer les onglets
      var tabEls = document.querySelectorAll('a[data-bs-toggle="tab"]');
      tabEls.forEach(function(tabEl) {
        tabEl.addEventListener('click', function (e) {
          e.preventDefault();
          var tab = new bootstrap.Tab(tabEl);
          tab.show();
        });
      });
      
      // Activer le premier onglet par défaut
      var firstTabEl = document.querySelector('a[data-bs-toggle="tab"]');
      if (firstTabEl) {
        var firstTab = new bootstrap.Tab(firstTabEl);
        firstTab.show();
      }
    });
  </script>
</div>
{% endblock %}
